<!DOCTYPE html>
<html>

<head>
    <title>Political Chess</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
        }

        #game-container {
            margin-top: 20px;
            display: none;
        }

        #game-board {
            width: 900px;
            height: 900px;
            border: 2px solid #333;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
        }

        .square {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .square.light {
            background-color: #fff;
        }

        .square.dark {
            background-color: #ccc;
        }

        .piece {
            position: absolute;
            width: 100%;
            height: 100%;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .piece img {
            max-width: 80%;
            max-height: 80%;
        }

        .piece-name {
            font-size: 12px;
            text-align: center;
        }

        #menu {
            margin: 20px;
            text-align: center;
        }

        #game-link {
            margin: 10px;
            padding: 10px;
            background: #eee;
            display: none;
        }

        .highlight {
            background-color: rgba(255, 255, 0, 0.5);
        }

        .valid-move {
            background-color: rgba(0, 255, 0, 0.3);
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
</head>

<body>
    <h1>Political Chess</h1>

    <div id="menu">
        <button id="create-game">Create New Game</button>
        <div id="game-link"></div>
        <div id="join-form" style="display: none;">
            <input type="text" id="game-id" placeholder="Enter Game ID">
            <button id="join-game">Join Game</button>
        </div>
    </div>

    <div id="game-container">
        <div id="status"></div>
        <div id="game-board"></div>
    </div>

    <script>
        const socket = io();
        let myColor = null;
        let selectedPiece = null;
        let gameId = null;

        // Create game button handler
        document.getElementById('create-game').onclick = () => {
            gameId = Math.random().toString(36).substring(2, 8);
            socket.emit('create_game', { game_id: gameId });

            // Show and update the shareable link
            const gameLink = document.getElementById('game-link');
            gameLink.style.display = 'block';
            gameLink.textContent = `Share this link: ${window.location.origin}?game=${gameId}`;

            document.getElementById('menu').style.display = 'none';
            document.getElementById('game-container').style.display = 'block';
        };

        // Join game button handler
        document.getElementById('join-game').onclick = () => {
            gameId = document.getElementById('game-id').value;
            socket.emit('join_game', { game_id: gameId });
        };

        // Check URL for game ID on load
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const gameIdFromUrl = urlParams.get('game');
            if (gameIdFromUrl) {
                document.getElementById('game-id').value = gameIdFromUrl;
                document.getElementById('join-form').style.display = 'block';
            }
        };

        // Socket event handlers
        socket.on('game_created', (data) => {
            myColor = data.color;
            updateBoard(data.board);
            updateStatus(`You are playing as ${myColor}. Waiting for opponent...`);
        });

        socket.on('game_joined', (data) => {
            myColor = data.color;
            updateBoard(data.board);
            document.getElementById('menu').style.display = 'none';
            document.getElementById('game-container').style.display = 'block';
            updateStatus(`You are playing as ${myColor}`);
        });

        socket.on('opponent_joined', (data) => {
            updateStatus(`Game started! ${data.current_turn}'s turn`);
        });

        socket.on('move_made', (data) => {
            updateBoard(data.board);
            updateStatus(`${data.current_turn}'s turn`);
        });

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        function updateBoard(board) {
            const gameBoard = document.getElementById('game-board');
            gameBoard.innerHTML = '';

            for (let y = 0; y < 8; y++) {
                for (let x = 0; x < 8; x++) {
                    const square = document.createElement('div');
                    square.className = `square ${(x + y) % 2 === 0 ? 'light' : 'dark'}`;
                    square.dataset.x = x;
                    square.dataset.y = y;

                    if (board[y][x]) {
                        const piece = board[y][x];
                        const pieceDiv = createPieceElement(piece);
                        square.appendChild(pieceDiv);
                    }

                    square.onclick = handleSquareClick;
                    gameBoard.appendChild(square);
                }
            }
        }

        function createPieceElement(piece) {
            const pieceDiv = document.createElement('div');
            pieceDiv.className = `piece ${piece.color}`;
            pieceDiv.dataset.type = piece.type;
            pieceDiv.dataset.color = piece.color;

            const img = document.createElement('img');
            img.src = `/assets/${piece.type}_${piece.color}.png`;
            pieceDiv.appendChild(img);

            const name = document.createElement('div');
            name.className = 'piece-name';
            name.textContent = piece.name;
            pieceDiv.appendChild(name);

            return pieceDiv;
        }

        function handleSquareClick(event) {
            const square = event.currentTarget;
            const x = parseInt(square.dataset.x);
            const y = parseInt(square.dataset.y);

            if (selectedPiece) {
                socket.emit('make_move', {
                    game_id: gameId,
                    from_x: parseInt(selectedPiece.parentElement.dataset.x),
                    from_y: parseInt(selectedPiece.parentElement.dataset.y),
                    to_x: x,
                    to_y: y
                });
                selectedPiece.classList.remove('highlight');
                selectedPiece = null;
                clearValidMoves();
            } else {
                const piece = square.querySelector('.piece');
                if (piece && piece.dataset.color === myColor) {
                    selectedPiece = piece;
                    piece.classList.add('highlight');
                    showValidMoves(x, y);
                }
            }
        }

        function showValidMoves(x, y) {
            // You'll need to implement this based on your game rules
            // For now, just highlight adjacent squares as an example
            const squares = document.querySelectorAll('.square');
            squares.forEach(square => {
                const squareX = parseInt(square.dataset.x);
                const squareY = parseInt(square.dataset.y);
                if (Math.abs(squareX - x) <= 1 && Math.abs(squareY - y) <= 1) {
                    square.classList.add('valid-move');
                }
            });
        }

        function clearValidMoves() {
            document.querySelectorAll('.valid-move').forEach(square => {
                square.classList.remove('valid-move');
            });
        }
    </script>
</body>

</html>